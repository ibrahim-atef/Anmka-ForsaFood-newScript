import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:customer/constant/constant.dart';
import 'package:customer/constant/collection_name.dart';
import 'package:customer/models/product_model.dart';
import 'package:customer/models/vendor_category_model.dart';
import 'package:customer/utils/fire_store_utils.dart';
import 'package:flutter/material.dart';

class SpecialProductsManager {
  static final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  
  /// Ø¥Ù†Ø´Ø§Ø¡ ÙØ¦Ø© Ø®Ø§ØµØ© Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø®Ø§ØµØ©
  static Future<void> createSpecialProductsCategory() async {
    try {
      print("ğŸ Creating special products category...");
      
      final specialCategoryData = {
        'id': 'special_products_category',
        'title': 'Special Offers',
        'photo': 'https://firebasestorage.googleapis.com/v0/b/foodies-3c1d9.appspot.com/o/special_products%2Fspecial_offers.png?alt=media&token=special_offers_category',
        'publish': true,
        'show_in_homepage': true,
        'createdAt': FieldValue.serverTimestamp(),
        'description': 'Special offers and unique items',
      };
      
      await _firestore
          .collection(CollectionName.vendorCategories)
          .doc('special_products_category')
          .set(specialCategoryData);
      
      print("âœ… Special products category created successfully");
      
    } catch (e) {
      print("âŒ Error creating special products category: $e");
    }
  }
  
  /// Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ÙŠÙ† Ø®Ø§ØµÙŠÙ† Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø·Ø§Ø¹Ù…
  static Future<void> addSpecialProductsToAllStores() async {
    try {
      print("ğŸš€ Starting to add special products to all stores...");
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø®Ø§ØµØ© Ø£ÙˆÙ„Ø§Ù‹
      await createSpecialProductsCategory();
      
      // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø·Ø§Ø¹Ù…
      final restaurants = await _firestore
          .collection(CollectionName.vendors)
          .get();
      
      print("ğŸ“Š Found ${restaurants.docs.length} restaurants");
      
      int successCount = 0;
      int errorCount = 0;
      
      for (var restaurantDoc in restaurants.docs) {
        try {
          final restaurantId = restaurantDoc.id;
          final restaurantData = restaurantDoc.data();
          
          print("ğŸª Processing restaurant: ${restaurantData['title']} (ID: $restaurantId)");
          
          // Ø¥Ø¶Ø§ÙØ© Mystery Box
          await _addMysteryBox(restaurantId);
          
          // Ø¥Ø¶Ø§ÙØ© Gift Bag
          await _addGiftBag(restaurantId);
          
          successCount++;
          print("âœ… Successfully added special products to restaurant: ${restaurantData['title']}");
          
        } catch (e) {
          errorCount++;
          print("âŒ Error adding special products to restaurant ${restaurantDoc.id}: $e");
        }
      }
      
      print("ğŸ‰ Special products addition completed!");
      print("âœ… Successfully processed: $successCount restaurants");
      print("âŒ Errors: $errorCount restaurants");
      
    } catch (e) {
      print("ğŸ’¥ Fatal error in addSpecialProductsToAllStores: $e");
    }
  }
  
  /// Ø¥Ø¶Ø§ÙØ© Mystery Box Ù„Ù„Ù…Ø·Ø¹Ù…
  static Future<void> _addMysteryBox(String restaurantId) async {
    final mysteryBoxData = {
      'addOnsPrice': <String>[],
      'addOnsTitle': <String>[],
      'availability_duration': 24,
      'calories': 0,
      'categoryID': 'special_products_category', // ÙØ¦Ø© Ø®Ø§ØµØ© Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø®Ø§ØµØ©
      'createdAt': FieldValue.serverTimestamp(),
      'description': 'A surprise box containing random items from our menu. Perfect for trying new flavors!',
      'disPrice': '0',
      'fats': 0,
      'grams': 0,
      'id': 'mystery_box_${restaurantId}',
      'item_attribute': null,
      'name': 'Mystery Box',
      'nonveg': false,
      'photo': 'https://firebasestorage.googleapis.com/v0/b/foodies-3c1d9.appspot.com/o/special_products%2Fmystery_box.png?alt=media&token=special_mystery_box',
      'photos': <String>[
        'https://firebasestorage.googleapis.com/v0/b/foodies-3c1d9.appspot.com/o/special_products%2Fmystery_box.png?alt=media&token=special_mystery_box'
      ],
      'price': '50.00',
      'product_specification': <String, String>{
        'Type': 'Surprise Box',
        'Contents': 'Random menu items',
        'Suitable for': 'Adventure seekers',
        'Purchase Limit': 'One per customer'
      },
      'proteins': 0,
      'publish': true, // Ù…Ù†Ø´ÙˆØ±
      'quantity': 1, // ÙŠÙ…ÙƒÙ† Ø´Ø±Ø§Ø¤Ù‡ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
      'takeawayOption': true,
      'veg': true,
      'vendorID': restaurantId,
      'reviewsCount': 0,
      'reviewsSum': 0.0,
      'isSpecialProduct': true, // Ø¹Ù„Ø§Ù…Ø© Ù„Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø®Ø§Øµ
      'purchaseLimit': 1, // Ø­Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡
    };
    
    await _firestore
        .collection(CollectionName.vendorProducts)
        .doc('mystery_box_${restaurantId}')
        .set(mysteryBoxData);
    
    print("ğŸ Added Mystery Box to restaurant: $restaurantId");
  }
  
  /// Ø¥Ø¶Ø§ÙØ© Gift Bag Ù„Ù„Ù…Ø·Ø¹Ù…
  static Future<void> _addGiftBag(String restaurantId) async {
    final giftBagData = {
      'addOnsPrice': <String>[],
      'addOnsTitle': <String>[],
      'availability_duration': 24,
      'calories': 0,
      'categoryID': 'special_products_category', // ÙØ¦Ø© Ø®Ø§ØµØ© Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø®Ø§ØµØ©
      'createdAt': FieldValue.serverTimestamp(),
      'description': 'A beautifully packaged gift bag perfect for special occasions and celebrations.',
      'disPrice': '0',
      'fats': 0,
      'grams': 0,
      'id': 'gift_bag_${restaurantId}',
      'item_attribute': null,
      'name': 'Gift Bag',
      'nonveg': false,
      'photo': 'https://firebasestorage.googleapis.com/v0/b/foodies-3c1d9.appspot.com/o/special_products%2Fgift_bag.png?alt=media&token=special_gift_bag',
      'photos': <String>[
        'https://firebasestorage.googleapis.com/v0/b/foodies-3c1d9.appspot.com/o/special_products%2Fgift_bag.png?alt=media&token=special_gift_bag'
      ],
      'price': '75.00',
      'product_specification': <String, String>{
        'Type': 'Gift Package',
        'Contents': 'Curated selection',
        'Perfect for': 'Special occasions',
        'Purchase Limit': 'One per customer'
      },
      'proteins': 0,
      'publish': true, // Ù…Ù†Ø´ÙˆØ±
      'quantity': 1, // ÙŠÙ…ÙƒÙ† Ø´Ø±Ø§Ø¤Ù‡ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
      'takeawayOption': true,
      'veg': true,
      'vendorID': restaurantId,
      'reviewsCount': 0,
      'reviewsSum': 0.0,
      'isSpecialProduct': true, // Ø¹Ù„Ø§Ù…Ø© Ù„Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø®Ø§Øµ
      'purchaseLimit': 1, // Ø­Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡
    };
    
    await _firestore
        .collection(CollectionName.vendorProducts)
        .doc('gift_bag_${restaurantId}')
        .set(giftBagData);
    
    print("ğŸ Added Gift Bag to restaurant: $restaurantId");
  }
  
  /// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø®Ø§Øµ
  static Future<bool> canPurchaseSpecialProduct(String productId, String userId) async {
    try {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      final orders = await _firestore
          .collection(CollectionName.orders)
          .where('userId', isEqualTo: userId)
          .where('status', whereIn: ['pending', 'accepted', 'preparing', 'ready', 'delivered'])
          .get();
      
      for (var orderDoc in orders.docs) {
        final orderData = orderDoc.data();
        final cartItems = orderData['cartItems'] as List<dynamic>?;
        
        if (cartItems != null) {
          for (var item in cartItems) {
            if (item['id'] == productId) {
              print("âŒ User has already purchased this special product");
              return false;
            }
          }
        }
      }
      
      print("âœ… User can purchase this special product");
      return true;
      
    } catch (e) {
      print("âŒ Error checking special product purchase eligibility: $e");
      return false;
    }
  }
  
  /// Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø·Ø§Ø¹Ù…
  static Future<void> removeSpecialProductsFromAllStores() async {
    try {
      print("ğŸ—‘ï¸ Starting to remove special products from all stores...");
      
      // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø·Ø§Ø¹Ù…
      final restaurants = await _firestore
          .collection(CollectionName.vendors)
          .get();
      
      int successCount = 0;
      int errorCount = 0;
      
      for (var restaurantDoc in restaurants.docs) {
        try {
          final restaurantId = restaurantDoc.id;
          
          // Ø­Ø°Ù Mystery Box
          await _firestore
              .collection(CollectionName.vendorProducts)
              .doc('mystery_box_${restaurantId}')
              .delete();
          
          // Ø­Ø°Ù Gift Bag
          await _firestore
              .collection(CollectionName.vendorProducts)
              .doc('gift_bag_${restaurantId}')
              .delete();
          
          successCount++;
          print("âœ… Successfully removed special products from restaurant: $restaurantId");
          
        } catch (e) {
          errorCount++;
          print("âŒ Error removing special products from restaurant ${restaurantDoc.id}: $e");
        }
      }
      
      // Ø­Ø°Ù Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø®Ø§ØµØ©
      await _firestore
          .collection(CollectionName.vendorCategories)
          .doc('special_products_category')
          .delete();
      
      print("ğŸ‰ Special products removal completed!");
      print("âœ… Successfully processed: $successCount restaurants");
      print("âŒ Errors: $errorCount restaurants");
      
    } catch (e) {
      print("ğŸ’¥ Fatal error in removeSpecialProductsFromAllStores: $e");
    }
  }
}

/// Widget Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø®Ø§ØµØ©
class SpecialProductsManagerWidget extends StatelessWidget {
  const SpecialProductsManagerWidget({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Special Products Manager'),
        backgroundColor: Colors.orange,
      ),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            const Text(
              'Special Products Manager',
              style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 20),
            const Text(
              'This tool will add Mystery Box and Gift Bag to all restaurants with proper category management.',
              style: TextStyle(fontSize: 16),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 30),
            ElevatedButton(
              onPressed: () async {
                showDialog(
                  context: context,
                  barrierDismissible: false,
                  builder: (context) => const AlertDialog(
                    content: Row(
                      children: [
                        CircularProgressIndicator(),
                        SizedBox(width: 20),
                        Text('Adding special products...'),
                      ],
                    ),
                  ),
                );
                
                await SpecialProductsManager.addSpecialProductsToAllStores();
                
                if (context.mounted) {
                  Navigator.pop(context);
                  ScaffoldMessenger.of(context).showSnackBar(
                    const SnackBar(
                      content: Text('Special products added successfully!'),
                      backgroundColor: Colors.green,
                    ),
                  );
                }
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.green,
                padding: const EdgeInsets.symmetric(vertical: 15),
              ),
              child: const Text(
                'Add Special Products to All Stores',
                style: TextStyle(fontSize: 16, color: Colors.white),
              ),
            ),
            const SizedBox(height: 15),
            ElevatedButton(
              onPressed: () async {
                showDialog(
                  context: context,
                  barrierDismissible: false,
                  builder: (context) => const AlertDialog(
                    content: Row(
                      children: [
                        CircularProgressIndicator(),
                        SizedBox(width: 20),
                        Text('Removing special products...'),
                      ],
                    ),
                  ),
                );
                
                await SpecialProductsManager.removeSpecialProductsFromAllStores();
                
                if (context.mounted) {
                  Navigator.pop(context);
                  ScaffoldMessenger.of(context).showSnackBar(
                    const SnackBar(
                      content: Text('Special products removed successfully!'),
                      backgroundColor: Colors.orange,
                    ),
                  );
                }
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.orange,
                padding: const EdgeInsets.symmetric(vertical: 15),
              ),
              child: const Text(
                'Remove Special Products from All Stores',
                style: TextStyle(fontSize: 16, color: Colors.white),
              ),
            ),
            const SizedBox(height: 30),
            const Text(
              'Note: Special products can only be purchased once per customer.',
              style: TextStyle(fontSize: 14, fontStyle: FontStyle.italic),
              textAlign: TextAlign.center,
            ),
          ],
        ),
      ),
    );
  }
}
