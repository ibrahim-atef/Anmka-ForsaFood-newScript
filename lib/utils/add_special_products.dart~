import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:customer/constant/constant.dart';
import 'package:customer/models/product_model.dart';
import 'package:customer/utils/fire_store_utils.dart';
import 'package:flutter/material.dart';

class SpecialProductsAdder {
  static final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  
  /// Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ÙŠÙ† Ø®Ø§ØµÙŠÙ† Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø·Ø§Ø¹Ù…
  static Future<void> addSpecialProductsToAllStores() async {
    try {
      print("ğŸš€ Starting to add special products to all stores...");
      
      // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø·Ø§Ø¹Ù…
      final restaurants = await _firestore
          .collection(CollectionName.vendor)
          .get();
      
      print("ğŸ“Š Found ${restaurants.docs.length} restaurants");
      
      int successCount = 0;
      int errorCount = 0;
      
      for (var restaurantDoc in restaurants.docs) {
        try {
          final restaurantId = restaurantDoc.id;
          final restaurantData = restaurantDoc.data();
          
          print("ğŸª Processing restaurant: ${restaurantData['title']} (ID: $restaurantId)");
          
          // Ø¥Ø¶Ø§ÙØ© Mystery Box
          await _addMysteryBox(restaurantId);
          
          // Ø¥Ø¶Ø§ÙØ© Gift Bag
          await _addGiftBag(restaurantId);
          
          successCount++;
          print("âœ… Successfully added special products to restaurant: ${restaurantData['title']}");
          
        } catch (e) {
          errorCount++;
          print("âŒ Error adding special products to restaurant ${restaurantDoc.id}: $e");
        }
      }
      
      print("ğŸ‰ Special products addition completed!");
      print("âœ… Successfully processed: $successCount restaurants");
      print("âŒ Errors: $errorCount restaurants");
      
    } catch (e) {
      print("ğŸ’¥ Fatal error in addSpecialProductsToAllStores: $e");
    }
  }
  
  /// Ø¥Ø¶Ø§ÙØ© Mystery Box Ù„Ù„Ù…Ø·Ø¹Ù…
  static Future<void> _addMysteryBox(String restaurantId) async {
    final mysteryBoxData = {
      'addOnsPrice': <String>[],
      'addOnsTitle': <String>[],
      'availability_duration': 24,
      'calories': 0,
      'categoryID': 'special_products', // ÙØ¦Ø© Ø®Ø§ØµØ© Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø®Ø§ØµØ©
      'createdAt': FieldValue.serverTimestamp(),
      'description': 'A surprise box containing random items from our menu. Perfect for trying new flavors!',
      'disPrice': '0',
      'fats': 0,
      'grams': 0,
      'id': 'mystery_box_${restaurantId}',
      'item_attribute': null,
      'name': 'Mystery Box',
      'nonveg': false,
      'photo': 'https://firebasestorage.googleapis.com/v0/b/foodies-3c1d9.appspot.com/o/special_products%2Fmystery_box.png?alt=media&token=special_mystery_box',
      'photos': <String>[
        'https://firebasestorage.googleapis.com/v0/b/foodies-3c1d9.appspot.com/o/special_products%2Fmystery_box.png?alt=media&token=special_mystery_box'
      ],
      'price': '50.00',
      'product_specification': <String, String>{
        'Type': 'Surprise Box',
        'Contents': 'Random menu items',
        'Suitable for': 'Adventure seekers'
      },
      'proteins': 0,
      'publish': true, // Ù…Ù†Ø´ÙˆØ±
      'quantity': -1, // ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯
      'takeawayOption': true,
      'veg': true,
      'vendorID': restaurantId,
      'reviewsCount': 0,
      'reviewsSum': 0.0,
    };
    
    await _firestore
        .collection(CollectionName.vendorProducts)
        .doc('mystery_box_${restaurantId}')
        .set(mysteryBoxData);
    
    print("ğŸ Added Mystery Box to restaurant: $restaurantId");
  }
  
  /// Ø¥Ø¶Ø§ÙØ© Gift Bag Ù„Ù„Ù…Ø·Ø¹Ù…
  static Future<void> _addGiftBag(String restaurantId) async {
    final giftBagData = {
      'addOnsPrice': <String>[],
      'addOnsTitle': <String>[],
      'availability_duration': 24,
      'calories': 0,
      'categoryID': 'special_products', // ÙØ¦Ø© Ø®Ø§ØµØ© Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø®Ø§ØµØ©
      'createdAt': FieldValue.serverTimestamp(),
      'description': 'A beautifully packaged gift bag perfect for special occasions and celebrations.',
      'disPrice': '0',
      'fats': 0,
      'grams': 0,
      'id': 'gift_bag_${restaurantId}',
      'item_attribute': null,
      'name': 'Gift Bag',
      'nonveg': false,
      'photo': 'https://firebasestorage.googleapis.com/v0/b/foodies-3c1d9.appspot.com/o/special_products%2Fgift_bag.png?alt=media&token=special_gift_bag',
      'photos': <String>[
        'https://firebasestorage.googleapis.com/v0/b/foodies-3c1d9.appspot.com/o/special_products%2Fgift_bag.png?alt=media&token=special_gift_bag'
      ],
      'price': '75.00',
      'product_specification': <String, String>{
        'Type': 'Gift Package',
        'Contents': 'Curated selection',
        'Perfect for': 'Special occasions'
      },
      'proteins': 0,
      'publish': true, // Ù…Ù†Ø´ÙˆØ±
      'quantity': -1, // ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯
      'takeawayOption': true,
      'veg': true,
      'vendorID': restaurantId,
      'reviewsCount': 0,
      'reviewsSum': 0.0,
    };
    
    await _firestore
        .collection(CollectionName.vendorProducts)
        .doc('gift_bag_${restaurantId}')
        .set(giftBagData);
    
    print("ğŸ Added Gift Bag to restaurant: $restaurantId");
  }
  
  /// Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø·Ø§Ø¹Ù… (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ø¬Ø©)
  static Future<void> removeSpecialProductsFromAllStores() async {
    try {
      print("ğŸ—‘ï¸ Starting to remove special products from all stores...");
      
      // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø·Ø§Ø¹Ù…
      final restaurants = await _firestore
          .collection(CollectionName.vendor)
          .get();
      
      int successCount = 0;
      int errorCount = 0;
      
      for (var restaurantDoc in restaurants.docs) {
        try {
          final restaurantId = restaurantDoc.id;
          
          // Ø­Ø°Ù Mystery Box
          await _firestore
              .collection(CollectionName.vendorProducts)
              .doc('mystery_box_${restaurantId}')
              .delete();
          
          // Ø­Ø°Ù Gift Bag
          await _firestore
              .collection(CollectionName.vendorProducts)
              .doc('gift_bag_${restaurantId}')
              .delete();
          
          successCount++;
          print("âœ… Successfully removed special products from restaurant: $restaurantId");
          
        } catch (e) {
          errorCount++;
          print("âŒ Error removing special products from restaurant ${restaurantDoc.id}: $e");
        }
      }
      
      print("ğŸ‰ Special products removal completed!");
      print("âœ… Successfully processed: $successCount restaurants");
      print("âŒ Errors: $errorCount restaurants");
      
    } catch (e) {
      print("ğŸ’¥ Fatal error in removeSpecialProductsFromAllStores: $e");
    }
  }
  
  /// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ù„Ù…Ø·Ø¹Ù… ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„ØªØ·ÙˆÙŠØ±)
  static Future<void> addSpecialProductsToSingleStore(String restaurantId) async {
    try {
      print("ğŸª Adding special products to single restaurant: $restaurantId");
      
      await _addMysteryBox(restaurantId);
      await _addGiftBag(restaurantId);
      
      print("âœ… Successfully added special products to restaurant: $restaurantId");
      
    } catch (e) {
      print("âŒ Error adding special products to restaurant $restaurantId: $e");
    }
  }
}

/// Widget Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø®Ø§ØµØ©
class SpecialProductsTestWidget extends StatelessWidget {
  const SpecialProductsTestWidget({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Special Products Manager'),
        backgroundColor: Colors.orange,
      ),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            const Text(
              'Special Products Manager',
              style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 20),
            const Text(
              'This tool will add Mystery Box and Gift Bag to all restaurants in your database.',
              style: TextStyle(fontSize: 16),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 30),
            ElevatedButton(
              onPressed: () async {
                showDialog(
                  context: context,
                  barrierDismissible: false,
                  builder: (context) => const AlertDialog(
                    content: Row(
                      children: [
                        CircularProgressIndicator(),
                        SizedBox(width: 20),
                        Text('Adding special products...'),
                      ],
                    ),
                  ),
                );
                
                await SpecialProductsAdder.addSpecialProductsToAllStores();
                
                if (context.mounted) {
                  Navigator.pop(context); // Ø¥ØºÙ„Ø§Ù‚ dialog
                  ScaffoldMessenger.of(context).showSnackBar(
                    const SnackBar(
                      content: Text('Special products added successfully!'),
                      backgroundColor: Colors.green,
                    ),
                  );
                }
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.green,
                padding: const EdgeInsets.symmetric(vertical: 15),
              ),
              child: const Text(
                'Add Special Products to All Stores',
                style: TextStyle(fontSize: 16, color: Colors.white),
              ),
            ),
            const SizedBox(height: 15),
            ElevatedButton(
              onPressed: () async {
                showDialog(
                  context: context,
                  barrierDismissible: false,
                  builder: (context) => const AlertDialog(
                    content: Row(
                      children: [
                        CircularProgressIndicator(),
                        SizedBox(width: 20),
                        Text('Removing special products...'),
                      ],
                    ),
                  ),
                );
                
                await SpecialProductsAdder.removeSpecialProductsFromAllStores();
                
                if (context.mounted) {
                  Navigator.pop(context); // Ø¥ØºÙ„Ø§Ù‚ dialog
                  ScaffoldMessenger.of(context).showSnackBar(
                    const SnackBar(
                      content: Text('Special products removed successfully!'),
                      backgroundColor: Colors.orange,
                    ),
                  );
                }
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.orange,
                padding: const EdgeInsets.symmetric(vertical: 15),
              ),
              child: const Text(
                'Remove Special Products from All Stores',
                style: TextStyle(fontSize: 16, color: Colors.white),
              ),
            ),
            const SizedBox(height: 30),
            const Text(
              'Note: After adding the products, you can delete this file.',
              style: TextStyle(fontSize: 14, fontStyle: FontStyle.italic),
              textAlign: TextAlign.center,
            ),
          ],
        ),
      ),
    );
  }
}
